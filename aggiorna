#!/bin/bash

#== Colori per gli output ==
GREEN='\e[32m'
BLUE='\e[34m'
RED='\e[31m'
YELLOW='\e[33m'
RESET='\e[0m'
PURPLE='\e[35m'
BOLD='\e[1m'

#== Impostazioni opzioni per successo o errori ==
log_success() {
    echo -e "${BOLD}${BLUE}✔ $1 completato con successo.${RESET}"
}

log_error() {
    echo -e "${BOLD}${RED}✖ Errore durante: $1${RESET}"
}

run_step() {
    local description="$1"
    shift
    if "$@"; then
        log_success "$description"
    else
        log_error "$description"
    fi
}

#== Stemma ==
echo -e "${GREEN}"
echo "*******************************"
echo "*                             *" 
echo "*   Aggiorna 3.0 by R∞tGPT    *"
echo "*                             *"
echo "*******************************"
echo -e "${RESET}"

#== Inizio aggiornamento e manutenzione ==
sudo echo -e "${BOLD}${PURPLE}Avvio script di aggiornamento e manutenzione del sistema...${RESET}"

#== Controllo dipendenze ==
echo -e "${BOLD}${YELLOW}Ricerca dipendenze in corso...${RESET}"

# Verifica se nala è installato
if ! command -v nala &> /dev/null; then
    echo -e "${BOLD}${YELLOW}Nala non trovato. Installazione in corso...${RESET}"
    sudo apt update
    sudo apt install -y nala
    if [ $? -eq 0 ]; then
        log_success "Installazione Nala"
    else
        log_error "Installazione Nala"
        echo -e "${BOLD}${RED}Impossibile installare Nala. Lo script terminerà.${RESET}"
        exit 1
    fi
else
    echo -e "${BOLD}${BLUE}Nala già presente nel sistema.${RESET}"
fi

echo -e "${BOLD}${GREEN}✔ Tutte le dipendenze sono state risolte.${RESET}"

#== Aggiornamento e manutenzione con Nala ==
run_step "Aggiornamento Nala" sudo nala update && sudo nala upgrade -y
run_step "Pulizia pacchetti inutilizzati Nala" sudo nala autoremove -y
run_step "Aggiornamento Flatpak" sudo flatpak update -y
run_step "Rimozione Flatpak non utilizzati" sudo flatpak uninstall --unused -y

#== Controlla ed esegui cromup se presente ==
if [ -x "/usr/local/bin/cromup" ]; then
    cromup
fi

#== Autoaggiornamento dello script ==
echo -e "${BOLD}${PURPLE}Controllo aggiornamenti dello script...${RESET}"
{
    sudo curl -fsSL https://raw.githubusercontent.com/RootGPT-YouTube/PiOSUP/main/aggiorna -o /tmp/aggiorna.tmp && \
    sudo mv /tmp/aggiorna.tmp /usr/local/bin/aggiorna && sudo chmod a+x /usr/local/bin/aggiorna
    log_success "Verifica aggiornamenti script"
} 2>/dev/null

#== Ultimo messaggio ==
echo -e "${BOLD}${PURPLE}✔ Script terminato. Premere un tasto per continuare...${RESET}"
read
# == Termine dello script ==
